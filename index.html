<canvas id="canvas" width="400" height="400"></canvas>
<script>
  ctx = document.getElementById("canvas").getContext('2d');

  let board = Array(10).fill(null).map(() => Array(10).fill(0));
  function boardEach(cb) {
    each(board, (x, y, item) => {
      const ret = cb(x, y, item);
      if (ret !== undefined) {
        board[x][y] = ret;
      }
    });
  }

  function boardSet(x, y, v) {
    board[y][x] = v;
  }

  function blockEach(block, cb) {
    each(block, (x, y, item) => {
      cb(x, y, item);
    });
  }

  function each(block, cb) {
    block.forEach((row, y) => {
      row.forEach((item, x) => {
        cb(x, y, item);
      });
    });
  }

  function blockRotate(block) {
    const newBlock = [];
    blockEach(block, (x, y, item) => {
      newBlock[x] = newBlock[x] || [];
      newBlock[x][y] = item;  
    });
    return newBlock;
  }

  const color = [
    { r: 512, g: 512, b: 512 },// white
    { r: 0, g: 0, b: 0 },      // black
    { r: 255, g: 0, b: 0 },    // red
    { r: 0, g: 255, b: 0 },    // green
    { r: 0, g: 0, b: 255 },    // blue
    { r: 255, g: 255, b: 0 },  // yellow
    { r: 255, g: 20, b: 147 }, // pink
    { r: 255, g: 99, b: 71 },  // orange
  ];

  const block = [
    [
      [2, 2, 2, 2],
    ],
    [
      [0, 3, 0],
      [3, 3, 3],
    ],
    [
      [4, 0, 0],
      [4, 4, 4],
    ],
    [
      [5, 5, 0],
      [0, 5, 5],
    ],
    [
      [6, 6],
      [6, 6],
    ],
  ];
  
  const BLOCK_SIZE = 40;
  const BORDER_WIDTH = 4;
  const INNER_WIDTH = BLOCK_SIZE - (BORDER_WIDTH * 2);
  let loopBreak = false;

  function main() {
    initKey();
    // 描画ループ
    // loop(() => {
    //   drawBoard();
    // }, 1000/60);

    let currentBlock = { block: block[0], x: 3, y: 0 };
    let lastBlock = { block: block[0], x: 3, y: 0 };
    function drawBlocks() {
      blockEach(lastBlock.block, (x, y) => {
        boardSet(x + lastBlock.x, y + lastBlock.y, 0);
      });
      blockEach(currentBlock.block, (x, y, i) => {
        boardSet(x + currentBlock.x, y + currentBlock.y, i);
      });
      lastBlock = currentBlock;
    }

    function currentBlockMove(dx, dy) {
      lastBlock = {...currentBlock};
      currentBlock.x += dx;
      currentBlock.y += dy;
    }

    // ロジックループ
    loop(() => {
      drawBlocks();
      drawBoard();
    }, 1000);

    // 重力ループ
    loop(() => {
      currentBlockMove(0, 1);
    }, 2000);
  }

  function loop(cb, interval) {
    setTimeout(() => {
      cb();
      if (!loopBreak) {
        loop(cb, interval);
      }
    }, interval);
  }

  let currentKey = null;
  function initKey() {
    document.addEventListener("keydown", (key) => {
      switch(key.keyCode) {
        case 37:
          currentKey = "left";
          break;
        case 38:
          currentKey = "up";
          break;
        case 39:
          currentKey = "right";
          break;
        case 40:
          currentKey = "down";
          break;
        case 32:
          currentKey = "space";
          break;
        default:
          currentKey = null;
          break;
      }
    });
  }

  function key() {
    return currentKey;
  }

  function clearBoard() {
    board = Array(10).fill(null).map(() => Array(10).fill(0));
  }

  function drawBoard() {
    boardEach((x, y, c) => {
      drawBlock(x, y, color[c]);
    })
  }

  function drawBlock(x, y, color) {
    drawOuter(x, y, color);
    drawInner(x, y, color);
  }

  function drawOuter(x, y, color) {
    ctx.fillStyle = `rgb(${color.r},${color.g},${color.b})`;
    ctx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
  }

  function drawInner(x, y, color) {
    ctx.fillStyle = `rgb(${Math.floor(color.r/2)},${Math.floor(color.g/2)},${Math.floor(color.b/2)})`;
    ctx.fillRect((x * BLOCK_SIZE) + BORDER_WIDTH, (y * BLOCK_SIZE) + BORDER_WIDTH, INNER_WIDTH, INNER_WIDTH);
  }

  main();
</script>